const AWS = require('aws-sdk');

var Ec2Selector = function(tagName) {
  this.tagName = tagName;
}

Ec2Selector.prototype.select = function(enableStates, func) {

  var ec2 = new AWS.EC2();
  var params = {
    Filters: [{
      Name: `tag:${this.tagName}`,
      Values: ['ON', 'On', 'on', 'TRUE', 'True', 'true', '1']
    }]
  };

  ec2.describeInstances(params, function(err, data) {
    if (err) {
      console.log(err, err.stack);
    } else {
      var instanceIds = [];
      data.Reservations.forEach(function (reservation) {
        reservation.Instances.forEach(function (instance) {
          if (enableStates.indexOf(instance.State.Name) >= 0) {
            instanceIds.push(instance.InstanceId);
          }
        });
      });

      func(instanceIds);
    }
  });
}

module.exports = Ec2Selector;
